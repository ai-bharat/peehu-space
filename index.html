<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday Peehu! üåü</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
        }

        /* Background Elements */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0; /* Behind stars */
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float-particle 15s infinite ease-in-out;
            opacity: 0;
        }

        @keyframes float-particle {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            20% { opacity: 0.8; transform: translateY(80vh) scale(1); }
            80% { opacity: 0.8; transform: translateY(20vh) scale(1); }
            100% { transform: translateY(-10vh) scale(0); opacity: 0; }
        }

        .floating-emojis {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .floating-emoji {
            position: absolute;
            font-size: 2.5em; /* Slightly larger */
            animation: float-around 8s infinite linear;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        @keyframes float-around {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            width: 95%; /* Fluid width */
            margin: 20px auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 40px); /* Adjust for margin */
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 50px 20px;
            background: rgba(255, 255, 255, 0.15); /* Slightly less transparent */
            border-radius: 20px;
            backdrop-filter: blur(15px); /* More blur */
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 100%;
            max-width: 800px; /* Limit width for large screens */
        }

        .welcome-screen h1 {
            font-family: 'Inter', sans-serif;
            font-size: 4em; /* Larger for impact */
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            animation: celebratory-bounce 2s infinite, rainbow-glow 3s infinite;
            cursor: pointer;
            font-weight: 900; /* Bolder */
            letter-spacing: 2px;
        }

        @keyframes celebratory-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            10% { transform: translateY(-30px) scale(1.1); }
            30% { transform: translateY(-15px) scale(1.05); }
            40% { transform: translateY(-25px) scale(1.08); }
            60% { transform: translateY(-10px) scale(1.03); }
        }

        @keyframes rainbow-glow {
            0% { text-shadow: 0 0 20px #ff6b6b, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            16% { text-shadow: 0 0 20px #ffd93d, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            32% { text-shadow: 0 0 20px #6bcf7f, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            48% { text-shadow: 0 0 20px #4ecdc4, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            64% { text-shadow: 0 0 20px #45b7aa, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            80% { text-shadow: 0 0 20px #96ceb4, 3px 3px 6px rgba(0, 0, 0, 0.4); }
            100% { text-shadow: 0 0 20px #ff6b6b, 3px 3px 6px rgba(0, 0, 0, 0.4); }
        }

        .welcome-screen p {
            font-size: 1.4em; /* Slightly larger */
            color: #fff;
            margin-bottom: 40px; /* More space */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
            line-height: 1.5;
        }

        .games-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted for smaller screens */
            gap: 25px; /* More space between cards */
            width: 100%;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.2); /* Slightly more transparent */
            border-radius: 20px; /* More rounded */
            padding: 30px; /* More padding */
            text-align: center;
            backdrop-filter: blur(12px);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
            border: 3px solid transparent; /* Thicker border */
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .game-card:hover {
            transform: translateY(-8px) scale(1.07); /* More pronounced lift */
            border-color: #ffeaa7; /* Gold border on hover */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            animation: card-celebration 0.6s ease;
            background: rgba(255, 255, 255, 0.3); /* More opaque on hover */
        }

        @keyframes card-celebration {
            0% { transform: translateY(-8px) scale(1.07); }
            25% { transform: translateY(-12px) scale(1.1) rotate(2deg); }
            50% { transform: translateY(-15px) scale(1.12) rotate(-1deg); }
            75% { transform: translateY(-12px) scale(1.1) rotate(1deg); }
            100% { transform: translateY(-8px) scale(1.07); }
        }

        .game-card h3 {
            color: #fff;
            font-size: 1.8em; /* Larger font */
            margin-bottom: 15px;
            font-weight: 700;
        }

        .game-card p {
            color: #fff;
            opacity: 0.95; /* Less opaque */
            font-size: 1.1em;
        }

        /* Game Screens */
        .game-screen {
            display: none;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(15px);
            color: #fff;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 15px;
        }

        .back-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); /* Gradient button */
            color: white;
            border: none;
            padding: 12px 25px; /* More padding */
            border-radius: 30px; /* More rounded */
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #ee5253 0%, #ff6b6b 100%);
            transform: scale(1.08); /* More pronounced scale */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .score {
            font-size: 1.4em; /* Larger score */
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Quiz Game Styles */
        .quiz-question {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            min-height: 120px; /* Ensure consistent height */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .quiz-question h3 {
            font-size: 1.6em;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjusted for options */
            gap: 20px;
            margin-top: 20px;
        }

        .quiz-option {
            background: rgba(255, 255, 255, 0.25); /* Slightly more opaque */
            border: none;
            padding: 18px; /* More padding */
            border-radius: 12px; /* More rounded */
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.06); /* More pronounced scale */
            animation: happy-wiggle 0.5s ease;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        @keyframes happy-wiggle {
            0%, 100% { transform: scale(1.06) rotate(0deg); }
            25% { transform: scale(1.09) rotate(2deg); }
            75% { transform: scale(1.09) rotate(-2deg); }
        }

        .star-jar {
            display: flex;
            justify-content: center;
            gap: 15px; /* More space */
            margin: 25px 0;
        }

        .star-icon {
            font-size: 2.5em; /* Larger stars */
            color: #ffd700;
            opacity: 0.3;
            transition: all 0.5s ease;
            text-shadow: 0 0 5px rgba(255,215,0,0.5);
        }

        .star-icon.filled {
            opacity: 1;
            animation: starFill 0.7s ease forwards; /* Slower, more impactful fill */
        }

        @keyframes starFill {
            0% { transform: scale(0.5) rotate(0deg); opacity: 0.3; }
            50% { transform: scale(1.3) rotate(15deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .quiz-feedback {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            color: #ffeaa7; /* Gold color for feedback */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            min-height: 50px; /* Reserve space */
        }

        /* Memory Game Styles */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px; /* Slightly more gap */
            max-width: 450px; /* Larger grid */
            margin: 20px auto;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
        }

        .memory-card {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            border-radius: 12px;
            font-size: 2.5em; /* Larger symbols */
            cursor: pointer;
            transition: all 0.3s ease;
            color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .memory-card:hover {
            transform: scale(1.07);
            animation: memory-joy 0.4s ease;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }

        @keyframes memory-joy {
            0% { transform: scale(1.07); }
            50% { transform: scale(1.12) rotate(5deg); }
            100% { transform: scale(1.07); }
        }

        .memory-card.flipped {
            background: rgba(255, 255, 255, 0.9); /* Brighter when flipped */
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .memory-card.matched {
            background: linear-gradient(45deg, #4ecdc4 0%, #45b7aa 100%); /* Gradient for matched */
            color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: matched-pop 0.6s ease forwards;
        }

        @keyframes matched-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* Birthday Cake Builder Styles */
        .cake-builder-game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .cake-area {
            position: relative;
            width: 100%;
            max-width: 400px; /* Fixed width for cake */
            height: 450px; /* Fixed height */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            overflow: hidden;
            border: 3px dashed rgba(255,255,255,0.5); /* Dotted border for drop zone */
            display: flex;
            flex-direction: column-reverse; /* Stack elements from bottom up */
            align-items: center;
            justify-content: flex-start;
            padding-bottom: 20px; /* Space for the base */
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .cake-area.highlight {
            border-color: #ffd700;
            background: rgba(0, 0, 0, 0.3);
        }

        .cake-component {
            position: absolute;
            bottom: 0; /* Start from the bottom */
            transition: all 0.3s ease-out;
            pointer-events: none; /* Make components non-interactive after placement */
            z-index: 10; /* Ensure components stack correctly */
            transform-origin: bottom center;
        }

        .cake-component.layer {
            width: 80%;
            height: 80px;
            background: linear-gradient(to bottom, #f0e68c, #e0d67c); /* Light yellow cake with gradient */
            border-radius: 40px / 10px; /* Oval shape for cake layer */
            border: 2px solid #b8860b;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 -5px 5px rgba(0,0,0,0.2);
            transform: perspective(500px) rotateX(5deg); /* Slight 3D tilt */
        }
        /* Specific cake layer colors */
        .cake-component.layer[data-component-id="layer2"] { background: linear-gradient(to bottom, #8b4513, #654321); border-color: #5a2a00; } /* Chocolate */
        .cake-component.layer[data-component-id="layer3"] { background: linear-gradient(to bottom, #ff69b4, #e05c9e); border-color: #c04c8a; } /* Strawberry */
        .cake-component.layer[data-component-id="layer4"] { background: linear-gradient(to bottom, #a52a2a, #8b0000); border-color: #6a0000; } /* Red Velvet */


        .cake-component.frosting {
            width: 85%;
            height: 30px;
            background: linear-gradient(to bottom, #ffb6c1, #e9967a); /* Light pink frosting with gradient */
            border-radius: 15px / 5px;
            border: 2px solid #e9967a;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2), inset 0 -3px 3px rgba(0,0,0,0.1);
            transform: perspective(500px) rotateX(5deg); /* Slight 3D tilt */
        }
        /* Specific frosting colors */
        .cake-component.frosting[data-component-id="frosting2"] { background: linear-gradient(to bottom, #f8f8ff, #e8e8e8); border-color: #d8d8d8; } /* White */
        .cake-component.frosting[data-component-id="frosting3"] { background: linear-gradient(to bottom, #87ceeb, #6495ed); border-color: #4682b4; } /* Blue */
        .cake-component.frosting[data-component-id="frosting4"] { background: linear-gradient(to bottom, #90ee90, #66cd00); border-color: #3cb371; } /* Green */


        .cake-component.decoration {
            position: absolute; /* Allow free placement for decorations */
            font-size: 2.5em;
            pointer-events: auto; /* Decorations can be moved after placement */
            cursor: grab;
            z-index: 15;
            text-shadow: 0 0 8px rgba(255,255,255,0.8); /* Glow for decorations */
            transition: transform 0.1s ease-out; /* Smooth movement for decorations */
        }
        
        /* Specific decoration styles */
        .decoration.cherry { font-size: 2.8em; color: #dc143c; }
        .decoration.candle {
            font-size: 2.8em;
            color: #ffd700; /* Candle body color */
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align candle base to the bottom */
            height: 1.2em; /* Adjust height to make flame appear on top */
            position: absolute; /* Keep absolute for positioning */
            pointer-events: auto; /* Make draggable */
            cursor: grab;
        }
        .decoration.candle::before {
            content: 'üî•'; /* Flame emoji */
            position: absolute;
            top: -0.5em; /* Position above the candle */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em; /* Smaller flame */
            animation: flicker 0.5s infinite alternate;
            pointer-events: none; /* Don't block clicks */
        }

        @keyframes flicker {
            0% { opacity: 0.8; transform: translateX(-50%) scale(1); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.1); }
            100% { opacity: 0.8; transform: translateX(-50%) scale(1); }
        }

        .decoration.sprinkles { font-size: 2.2em; color: #87ceeb; }
        .decoration.flower-decor { font-size: 2.8em; color: #ffc0cb; } /* Light pink flower */
        .decoration.balloon-decor { font-size: 2.8em; color: #ff4500; } /* Orange balloon */


        .cake-palette {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
        }

        .palette-item {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            padding: 15px;
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            font-size: 1.2em;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            min-height: 90px;
        }

        .palette-item:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .palette-item span.emoji {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .cake-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Cut the Cake Button Specific Styling */
        #cutCakeBtn {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); /* Gold to Orange gradient */
            color: #8b4513; /* Dark brown text */
            font-size: 1.3em; /* Larger font */
            padding: 15px 35px; /* More padding */
            border-radius: 40px; /* More rounded, pill-like */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.5); /* Stronger shadow, inner glow */
            animation: pulse-glow 1.5s infinite alternate; /* Pulsing animation */
        }

        #cutCakeBtn:hover {
            background: linear-gradient(135deg, #ff8c00 0%, #ffd700 100%); /* Reverse gradient on hover */
            transform: scale(1.1); /* More pronounced scale */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), inset 0 0 15px rgba(255, 255, 255, 0.7);
            animation: none; /* Stop pulsing on hover */
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.5); }
            100% { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), inset 0 0 15px rgba(255, 255, 255, 0.7); }
        }


        /* Confetti & Celebration Effects */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden; /* Ensure confetti doesn't cause scrollbars */
        }

        .confetti-piece {
            position: absolute;
            width: 12px; /* Larger confetti */
            height: 12px;
            background: #ffd700;
            border-radius: 50%; /* Default to circle */
            animation: confetti-fall 3s linear infinite;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .confetti-piece:nth-child(3n) { border-radius: 0; transform: rotate(45deg); } /* Square */
        .confetti-piece:nth-child(5n) { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); } /* Star */

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-80vh) rotate(180deg) scale(1); }
            80% { opacity: 1; transform: translateY(80vh) rotate(540deg) scale(1); }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Specific animation for corner confetti */
        @keyframes corner-confetti-left {
            0% { transform: translate(0, 100vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate(0, 90vh) rotate(30deg) scale(1); }
            50% { opacity: 1; transform: translate(20vw, 50vh) rotate(180deg) scale(1); }
            100% { transform: translate(50vw, -10vh) rotate(360deg) scale(0.5); opacity: 0; }
        }

        @keyframes corner-confetti-right {
            0% { transform: translate(100vw, 100vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 1; transform: translate(100vw, 90vh) rotate(-30deg) scale(1); }
            50% { opacity: 1; transform: translate(80vw, 50vh) rotate(-180deg) scale(1); }
            100% { transform: translate(50vw, -10vh) rotate(-360deg) scale(0.5); opacity: 0; }
        }


        .celebration-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1001;
        }

        .burst-emoji {
            position: absolute;
            font-size: 3.5em; /* Larger burst emojis */
            animation: burst-out 2s ease-out forwards;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        @keyframes burst-out {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; } /* Bigger pop */
            100% { transform: translate(-50%, -50%) scale(1) translateY(-250px); opacity: 0; } /* Higher float */
        }

        /* Custom Modal for Messages */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .custom-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .custom-modal-content {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 90%;
            width: 500px;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 3px solid #ffeaa7;
        }

        .custom-modal-overlay.visible .custom-modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .custom-modal-content h2 {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .custom-modal-content p {
            font-size: 1.3em;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .modal-close-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }

        .modal-close-btn:hover {
            background: linear-gradient(135deg, #ee5253 0%, #ff6b6b 100%);
            transform: scale(1.08);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px auto;
                min-height: calc(100vh - 20px);
            }

            .welcome-screen {
                padding: 30px 15px;
            }

            .welcome-screen h1 {
                font-size: 2.5em; /* Smaller on mobile */
                letter-spacing: 1px;
            }
            
            .welcome-screen p {
                font-size: 1.1em;
                margin-bottom: 25px;
            }

            .games-menu {
                grid-template-columns: 1fr; /* Stack cards on mobile */
                gap: 18px;
            }
            
            .game-card {
                padding: 20px;
            }

            .game-card h3 {
                font-size: 1.6em;
            }

            .game-card p {
                font-size: 1em;
            }

            .game-screen {
                padding: 20px;
            }

            .game-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .back-btn, .control-btn, .modal-close-btn {
                width: 100%; /* Full width buttons */
                max-width: 250px;
                padding: 10px 20px;
                font-size: 1em;
            }

            .score {
                font-size: 1.2em;
            }

            .quiz-question h3 {
                font-size: 1.3em;
            }

            .quiz-options {
                grid-template-columns: 1fr; /* Stack options */
                gap: 12px;
            }

            .quiz-option {
                padding: 15px;
                font-size: 1em;
            }

            .star-jar {
                gap: 10px;
            }

            .star-icon {
                font-size: 2em;
            }

            .memory-grid {
                grid-template-columns: repeat(3, 1fr); /* 3 columns for memory on mobile */
                gap: 8px;
                max-width: 300px;
            }

            .memory-card {
                font-size: 2em;
            }

            .cake-area {
                width: 90%;
                max-width: 300px;
                height: 350px;
            }

            .cake-palette {
                padding: 15px;
                gap: 10px;
            }

            .palette-item {
                min-width: 70px;
                min-height: 70px;
                font-size: 1em;
            }

            .palette-item span.emoji {
                font-size: 2em;
            }

            .custom-modal-content {
                padding: 25px;
            }

            .custom-modal-content h2 {
                font-size: 2em;
            }

            .custom-modal-content p {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="particles" id="particles"></div>
    <div class="floating-emojis" id="floatingEmojis"></div>
    
    <div class="container">
        <div class="welcome-screen" id="welcomeScreen">
            <h1 onclick="titleCelebration()">üåü Happy Birthday Peehu! üåü</h1>
            <p>Welcome to your magical birthday celebration! Three enchanting games await you, each designed to sprinkle extra joy on your special day!</p>
            <div class="games-menu">
                <div class="game-card" onclick="startQuiz(); showMiniConfetti()">
                    <h3>üß† Do You Know Peehu?</h3>
                    <p>Discover hilarious truths and fill the star jar with happiness!</p>
                </div>
                <div class="game-card" onclick="startMemory(); showMiniConfetti()">
                    <h3>üé¥ Memory Match</h3>
                    <p>Uncover pairs of birthday surprises and unleash a burst of joy!</p>
                </div>
                <div class="game-card" onclick="startCakeBuilder(); showMiniConfetti()">
                    <h3>üéÇ Birthday Cake Builder</h3>
                    <p>Design and decorate the ultimate birthday cake for Peehu!</p>
                </div>
            </div>
        </div>

        <!-- Quiz Game -->
        <div class="game-screen" id="quizGame">
            <div class="game-header">
                <button class="back-btn" onclick="goHome()">‚Üê Back to Games</button>
                <div class="score">Stars Collected: <span id="quizStarsCollected">0</span>/5</div>
            </div>
            <div class="star-jar">
                <span class="star-icon" id="star1">‚≠ê</span>
                <span class="star-icon" id="star2">‚≠ê</span>
                <span class="star-icon" id="star3">‚≠ê</span>
                <span class="star-icon" id="star4">‚≠ê</span>
                <span class="star-icon" id="star5">‚≠ê</span>
            </div>
            <div class="quiz-question">
                <h3 id="questionText">Loading question...</h3>
                <div class="quiz-feedback" id="quizFeedback"></div>
                <div class="quiz-options" id="quizOptions"></div>
            </div>
        </div>

        <!-- Memory Game -->
        <div class="game-screen" id="memoryGame">
            <div class="game-header">
                <button class="back-btn" onclick="goHome()">‚Üê Back to Games</button>
                <div class="score">Moves: <span id="memoryMoves">0</span></div>
            </div>
            <div class="memory-grid" id="memoryGrid"></div>
            <div class="controls">
                <button class="control-btn" onclick="resetMemory()">New Game</button>
            </div>
        </div>

        <!-- Birthday Cake Builder Game -->
        <div class="game-screen" id="cakeBuilderGame">
            <div class="game-header">
                <button class="back-btn" onclick="goHome()">‚Üê Back to Games</button>
                <h3 class="score">Build Your Cake!</h3>
            </div>
            <div class="cake-builder-game-container">
                <div class="cake-area" id="cakeArea" ondragover="allowDrop(event)" ondrop="drop(event)">
                    <!-- Cake components will be dropped here -->
                </div>
                <div class="cake-palette" id="cakePalette">
                    <!-- Palette items will be dynamically generated here -->
                </div>
                <div class="cake-controls">
                    <button class="control-btn" id="resetCakeBtn" onclick="resetCakeBuilder()">Reset Cake</button>
                    <button class="control-btn" id="finishCakeBtn" onclick="finishCake()">Finish Cake!</button>
                    <button class="control-btn" id="cutCakeBtn" onclick="cutCake()" style="display: none;">Cut the Cake! üî™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="customModalOverlay" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <button class="modal-close-btn" onclick="hideModal()">Close</button>
        </div>
    </div>

    <script>
        // --- Global Helper Functions ---

        // Creates the starry background
        function createStars() {
            const starsContainer = document.querySelector('.stars');
            for (let i = 0; i < 75; i++) { // More stars
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 4 + 's'; // Varied delays
                starsContainer.appendChild(star);
            }
        }

        // Creates subtle floating particles in the background
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30; // Number of particles
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 5 + 3; // Size between 3px and 8px
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's'; // Longer, varied delays
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's'; // Longer animation duration
                particlesContainer.appendChild(particle);
            }
        }

        // Creates floating emojis that drift across the screen
        function createFloatingEmojis() {
            const emojis = ['üéâ', 'üéà', 'üéÇ', 'üåü', 'üíñ', 'üéÅ', '‚ú®', 'üéä', 'ü¶Ñ', 'üåà', 'üíï', 'üéÄ', 'üëë', 'ü•≥', 'üå∏', 'üí´'];
            const container = document.getElementById('floatingEmojis');
            
            setInterval(() => {
                const emoji = document.createElement('div');
                emoji.className = 'floating-emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = Math.random() * 100 + '%';
                emoji.style.animationDuration = (Math.random() * 4 + 7) + 's'; // Varied duration
                emoji.style.animationDelay = Math.random() * 2 + 's'; // Staggered start
                container.appendChild(emoji);
                
                setTimeout(() => {
                    emoji.remove();
                }, 8000); // Remove after animation
            }, 1500); // More frequent emoji spawns
        }

        // Triggers a grand celebration when the title is clicked
        function titleCelebration() {
            showConfetti(200); // More confetti
            showBurstEmojis(20); // More burst emojis
            playHappySoundVisual();
            showModal("Hooray!", "The birthday magic has officially begun! Prepare for maximum joy!");
        }

        // Shows a full-screen confetti burst
        function showConfetti(count = 100, duration = 5000) {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti';
            document.body.appendChild(confettiContainer);

            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7aa', '#96ceb4', '#ffeaa7', '#fd79a8', '#fdcb6e', '#a29bfe', '#55efc4'];
            const shapes = ['circle', 'square', 'star'];
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = Math.random() * 100 + '%'; // Start from random top
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * (duration / 1000) + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                if (shape === 'square') {
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                } else if (shape === 'star') {
                    confetti.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                }
                confettiContainer.appendChild(confetti);
            }

            setTimeout(() => {
                confettiContainer.remove();
            }, duration);
        }

        // Shows a small, localized confetti burst for mini-interactions
        function showMiniConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti';
            document.body.appendChild(confettiContainer);

            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7aa', '#96ceb4', '#ffeaa7', '#fd79a8', '#fdcb6e'];
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 1 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                confettiContainer.appendChild(confetti);
            }

            setTimeout(() => {
                confettiContainer.remove();
            }, 3000);
        }

        // Shows a burst of emojis from the center
        function showBurstEmojis(count = 12) {
            const burstContainer = document.createElement('div');
            burstContainer.className = 'celebration-burst';
            document.body.appendChild(burstContainer);

            const burstEmojis = ['üéâ', 'üéà', 'üéÇ', 'üåü', 'üíñ', 'üéÅ', '‚ú®', 'üéä', 'ü•≥', 'üåà'];
            
            for (let i = 0; i < count; i++) {
                const emoji = document.createElement('div');
                emoji.className = 'burst-emoji';
                emoji.textContent = burstEmojis[Math.floor(Math.random() * burstEmojis.length)];
                // Distribute emojis around the center with random offsets
                const angle = (i / count) * Math.PI * 2;
                const radius = Math.random() * 100 + 50; // Spread out more
                emoji.style.left = `calc(50% + ${radius * Math.cos(angle)}px)`;
                emoji.style.top = `calc(50% + ${radius * Math.sin(angle)}px)`;
                emoji.style.animationDelay = i * 0.08 + 's'; // Staggered delay
                burstContainer.appendChild(emoji);
            }

            setTimeout(() => {
                burstContainer.remove();
            }, 2000);
        }

        // Provides visual feedback for a "happy sound"
        function playHappySoundVisual() {
            document.body.style.animation = 'happy-shake 0.5s ease';
            setTimeout(() => {
                document.body.style.animation = '';
            }, 500);
        }

        // Custom Modal functions (instead of alert/confirm)
        function showModal(title, message, onCloseCallback = null) {
            const modalOverlay = document.getElementById('customModalOverlay');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            const closeBtn = document.querySelector('.modal-close-btn');
            closeBtn.onclick = () => {
                hideModal();
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };

            modalOverlay.classList.add('visible');
        }

        function hideModal() {
            document.getElementById('customModalOverlay').classList.remove('visible');
        }

        // --- Quiz Game Logic ---
        const quizQuestions = [
            {
                question: "What's Peehu's secret talent that makes everyone giggle?",
                options: [
                    { text: "She can talk to animals (especially fluffy ones!)", response: "You're absolutely right! Her conversations with squirrels are legendary, though they mostly involve her trying to convince them to share their nuts. It's adorable!" },
                    { text: "She can turn grumpy frowns into happy smiles with just a look!", response: "Bingo! Peehu's smile is so powerful, it could probably solve world peace. We're still testing that theory, but results are promising!" },
                    { text: "She can find the hidden snack stash no matter how well it's hidden.", response: "A true detective! Her snack-finding skills are unparalleled. We suspect she has a built-in snack radar. Don't try to hide anything from Peehu!" },
                    { text: "She can make boring moments sparkle with her imagination!", response: "Precisely! Give Peehu a cardboard box, and she'll build a spaceship, a castle, or a time machine. Her imagination is truly out of this world!" }
                ]
            },
            {
                question: "If Peehu were a magical creature, what would she be?",
                options: [
                    { text: "A sparkly unicorn that grants wishes!", response: "Of course! A unicorn, but with extra glitter and a horn made of pure joy. Every wish she grants comes with a bonus hug!" },
                    { text: "A playful dragon who breathes confetti instead of fire!", response: "Exactly! Imagine a dragon who just wants to throw a party! Her roars are actually happy tunes, and her scales shimmer with all the colors of the rainbow!" },
                    { text: "A mischievous fairy who leaves trails of laughter wherever she flies!", response: "Spot on! She'd be the kind of fairy who sprinkles laughter dust and makes everyone's day brighter. Just watch out for sudden tickle attacks!" },
                    { text: "A wise owl who gives the best advice (and always knows where the cookies are).", response: "So true! A wise owl, but one who also knows how to have a hoot! Her advice is always spot-on, especially when it comes to the important things, like dessert!" }
                ]
            },
            {
                question: "What's Peehu's favorite way to spread happiness?",
                options: [
                    { text: "By telling the funniest jokes that make your tummy hurt from laughing!", response: "You got it! Her jokes are so good, they come with a warning label: 'May cause uncontrollable fits of laughter and happy tears!'" },
                    { text: "By giving the warmest, most squishy hugs that make everything better!", response: "Absolutely! Peehu's hugs are like a warm, fuzzy blanket on a cold day, but with extra sparkles. They're scientifically proven to cure bad moods!" },
                    { text: "By sharing her toys and making sure everyone feels included!", response: "That's Peehu! Her generosity is legendary. She believes that happiness is best when shared, especially when it involves her favorite toys!" },
                    { text: "By dancing like nobody's watching, even if everyone is!", response: "You nailed it! Peehu's dance moves are so infectious, they could start a spontaneous dance party anywhere. Even the furniture starts tapping its feet!" }
                ]
            },
            {
                question: "What's the most Peehu-tastic thing about Peehu?",
                options: [
                    { text: "Her super creative ideas that make every day an adventure!", response: "Precisely! Her brain is a factory of fantastic ideas, always churning out new ways to have fun and make life exciting. She's a true adventure architect!" },
                    { text: "Her kindness that shines brighter than a thousand suns!", response: "You know it! Her heart is made of pure gold and glitter. She's so kind, even grumpy clouds start smiling when she's around!" },
                    { text: "Her amazing ability to make friends wherever she goes!", response: "Absolutely! Peehu is a friendship magnet! She could make friends with a rock, and that rock would probably start telling jokes. That's her magic!" },
                    { text: "Her infectious enthusiasm for everything, big or small!", response: "That's the spirit! Her enthusiasm is so powerful, it could power a small city. She makes even chores seem like a grand quest!" }
                ]
            },
            {
                question: "If Peehu had a theme song, what would it be called?",
                options: [
                    { text: "'The Happy-Go-Lucky Sparkle Anthem!'", response: "Perfect title! It would be a chart-topper, guaranteed to make everyone jump for joy and maybe even sprout a few extra sparkles!" },
                    { text: "Peehu's Giggle-Powered Adventure!'", response: "Spot on! A song filled with laughter, unexpected twists, and a chorus that makes you want to explore the world with a skip in your step!" },
                    { text: "'The Queen of Kindness and Confetti!'", response: "You've captured her essence! This song would be a celebration of her loving heart and her uncanny ability to make confetti appear out of thin air!" },
                    { text: "'Born to Shine: The Peehu Story!'", response: "Yes! A true epic! It would tell the tale of a superstar who was destined to spread happiness and light wherever she goes. A masterpiece!" }
                ]
            }
        ];

        let currentQuizQuestionIndex = 0;
        let quizStarsCollected = 0;

        function startQuiz() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('quizGame').style.display = 'block';
            currentQuizQuestionIndex = 0;
            quizStarsCollected = 0;
            updateQuizStarsDisplay();
            showQuizQuestion();
        }

        function showQuizQuestion() {
            document.getElementById('quizFeedback').textContent = ''; // Clear previous feedback

            if (currentQuizQuestionIndex >= quizQuestions.length) {
                showQuizCompletionCelebration();
                return;
            }

            const questionData = quizQuestions[currentQuizQuestionIndex];
            document.getElementById('questionText').textContent = questionData.question;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'quiz-option';
                button.textContent = option.text;
                button.onclick = () => handleQuizAnswer(option.response);
                optionsContainer.appendChild(button);
            });
        }

        function handleQuizAnswer(responseMessage) {
            // Disable options to prevent multiple clicks
            document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);

            document.getElementById('quizFeedback').textContent = responseMessage;
            playHappySoundVisual();
            showMiniConfetti();
            showBurstEmojis(8); // Small burst for each answer

            quizStarsCollected++;
            updateQuizStarsDisplay();
            
            currentQuizQuestionIndex++;
            
            setTimeout(() => {
                showQuizQuestion();
            }, 3000); // Show next question after 3 seconds
        }

        function updateQuizStarsDisplay() {
            document.getElementById('quizStarsCollected').textContent = quizStarsCollected;
            for (let i = 1; i <= quizQuestions.length; i++) {
                const starElement = document.getElementById('star' + i);
                if (starElement) {
                    if (i <= quizStarsCollected) {
                        starElement.classList.add('filled');
                    } else {
                        starElement.classList.remove('filled');
                    }
                }
            }
        }

        function showQuizCompletionCelebration() {
            showConfetti(300, 7000); // Grand confetti
            showBurstEmojis(30); // Grand emoji burst
            playHappySoundVisual();
            showModal(
                "üéâ You're a Peehu Expert! üéâ",
                "Wow! You've unlocked all the secrets to Peehu's amazingness! Every answer was a burst of pure joy, just like her! Happy Birthday, our incredible Peehu!",
                goHome // Go home after closing modal
            );
        }

        // --- Memory Game Logic ---
        const memorySymbols = ['üéÇ', 'üéà', 'üéÅ', 'üåü', 'üéâ', 'üéä', 'üíù', 'üéÄ', 'ü•≥', 'üëë']; // More symbols
        let memoryCards = [];
        let flippedCards = [];
        let memoryMoves = 0;
        let matchesFound = 0;

        function startMemory() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('memoryGame').style.display = 'block';
            setupMemoryGame();
        }

        function setupMemoryGame() {
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = '';
            // Duplicate symbols and shuffle
            memoryCards = [...memorySymbols, ...memorySymbols].sort(() => Math.random() - 0.5);
            flippedCards = [];
            memoryMoves = 0;
            matchesFound = 0;
            document.getElementById('memoryMoves').textContent = memoryMoves;

            memoryCards.forEach((symbol, index) => {
                const card = document.createElement('button');
                card.className = 'memory-card';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                card.onclick = () => flipCard(card);
                grid.appendChild(card);
            });
        }

        function flipCard(card) {
            if (flippedCards.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                card.classList.add('flipped');
                card.textContent = card.dataset.symbol;
                flippedCards.push(card);
                showMiniConfetti(); // Mini confetti for every flip

                if (flippedCards.length === 2) {
                    memoryMoves++;
                    document.getElementById('memoryMoves').textContent = memoryMoves;
                    
                    setTimeout(() => {
                        checkMatch();
                    }, 1000);
                }
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.dataset.symbol === card2.dataset.symbol) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                card1.disabled = true; // Disable matched cards
                card2.disabled = true;
                matchesFound++;
                playHappySoundVisual();
                showConfetti(50, 2000); // Small confetti for a match
                showBurstEmojis(10); // Small burst for a match
                
                if (matchesFound === memorySymbols.length) { // All pairs found
                    setTimeout(() => {
                        showConfetti(200, 5000);
                        showBurstEmojis(20);
                        showModal('üéâ Memory Master! üéâ', `You found all the pairs in ${memoryMoves} moves! You're a memory marvel!`, goHome);
                    }, 500);
                }
            } else {
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.textContent = '';
                card2.textContent = '';
                // Still show mini confetti for trying!
                showMiniConfetti();
            }
            
            flippedCards = [];
        }

        function resetMemory() {
            setupMemoryGame();
        }

        // --- Birthday Cake Builder Game Logic ---
        const cakeComponents = [
            { id: 'layer1', type: 'layer', emoji: 'üç∞', name: 'Vanilla Layer' },
            { id: 'frosting1', type: 'frosting', emoji: 'üç¶', name: 'Pink Frosting' },
            { id: 'layer2', type: 'layer', emoji: 'üç∞', name: 'Chocolate Layer' },
            { id: 'frosting2', type: 'frosting', emoji: 'üç¶', name: 'White Frosting' },
            { id: 'layer3', type: 'layer', emoji: 'üç∞', name: 'Strawberry Layer' },
            { id: 'frosting3', type: 'frosting', emoji: 'üç¶', name: 'Blue Frosting' },
            { id: 'layer4', type: 'layer', emoji: 'üç∞', name: 'Red Velvet Layer' }, // New layer
            { id: 'frosting4', type: 'frosting', emoji: 'üç¶', name: 'Green Frosting' }, // New frosting
            { id: 'cherry', type: 'decoration', emoji: 'üçí', name: 'Cherry' },
            { id: 'candle', type: 'decoration', emoji: 'üïØÔ∏è', name: 'Candle' },
            { id: 'sprinkles', type: 'decoration', emoji: '‚ú®', name: 'Sprinkles' },
            { id: 'star-decor', type: 'decoration', emoji: '‚≠ê', name: 'Star' },
            { id: 'heart-decor', type: 'decoration', emoji: 'üíñ', name: 'Heart' },
            { id: 'flower-decor', type: 'decoration', emoji: 'üåº', name: 'Flower' }, // New decoration
            { id: 'balloon-decor', type: 'decoration', emoji: 'üéà', name: 'Balloon' } // New decoration
        ];

        let cakeLayers = []; // Stores the elements currently on the cake
        let cakeArea = null;
        let cakePalette = null;
        let totalComponentsAdded = 0; // Track total components for mid-game messages

        function startCakeBuilder() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('cakeBuilderGame').style.display = 'block';
            cakeArea = document.getElementById('cakeArea');
            cakePalette = document.getElementById('cakePalette');
            
            // Add dragleave listener here, after cakeArea is defined
            cakeArea.addEventListener('dragleave', () => {
                cakeArea.classList.remove('highlight');
            });

            resetCakeBuilder(); // Initialize or reset the game
        }

        function resetCakeBuilder() {
            if (cakeArea) { // Check if cakeArea is not null
                cakeArea.innerHTML = ''; // Clear cake area
            }
            cakeLayers = []; // Reset layers
            totalComponentsAdded = 0; // Reset counter
            if (cakePalette) { // Check if cakePalette is not null
                populateCakePalette(); // Repopulate palette
            }
            if (cakeArea) { // Check if cakeArea is not null
                cakeArea.style.border = '3px dashed rgba(255,255,255,0.5)'; // Reset border
                cakeArea.classList.remove('highlight');
            }
            // Ensure cutCakeBtn is hidden and other buttons are visible
            document.getElementById('cutCakeBtn').style.display = 'none';
            document.getElementById('resetCakeBtn').style.display = 'inline-block';
            document.getElementById('finishCakeBtn').style.display = 'inline-block';
        }

        function populateCakePalette() {
            cakePalette.innerHTML = '';
            cakeComponents.forEach(component => {
                const item = document.createElement('div');
                item.className = 'palette-item';
                item.setAttribute('draggable', true);
                item.dataset.componentId = component.id;
                item.dataset.componentType = component.type;
                item.innerHTML = `<span class="emoji">${component.emoji}</span>${component.name}`;
                item.addEventListener('dragstart', drag);
                cakePalette.appendChild(item);
            });
        }

        function allowDrop(event) {
            event.preventDefault(); // Allow drop
            cakeArea.classList.add('highlight'); // Visual feedback for drop zone
        }

        function drag(event) {
            event.dataTransfer.setData("text/plain", event.target.dataset.componentId);
        }

        function drop(event) {
            event.preventDefault();
            cakeArea.classList.remove('highlight');

            const data = event.dataTransfer.getData("text/plain");
            const component = cakeComponents.find(c => c.id === data);

            if (!component) return;

            const newElement = document.createElement('div');
            newElement.className = `cake-component ${component.type}`;
            newElement.textContent = component.emoji; // For decorations
            newElement.style.zIndex = totalComponentsAdded + 10; // Ensure higher z-index for new components
            newElement.dataset.componentId = component.id; // Store component ID for specific styling

            if (component.type === 'layer' || component.type === 'frosting') {
                // For layers and frosting, stack them
                const currentHeight = cakeLayers.reduce((sum, el) => sum + el.offsetHeight, 0);
                newElement.style.bottom = `${currentHeight}px`;
                cakeArea.appendChild(newElement);
                cakeLayers.push(newElement);
                playHappySoundVisual();
                showMiniConfetti();
                showBurstEmojis(5); // Small burst for adding a component

                if (component.type === 'layer' && cakeLayers.filter(el => el.classList.contains('layer')).length === 1) {
                    showModal("A Sweet Start!", "You've laid the delicious foundation for Peehu's birthday cake! Looking scrumptious already!");
                } else if (component.type === 'frosting' && cakeLayers.filter(el => el.classList.contains('frosting')).length === 1) {
                    showModal("Frosting Fun!", "That's the perfect touch of sweetness for Peehu's special day! Keep frosting!");
                }
            } else if (component.type === 'decoration') {
                // For decorations, allow free placement within the cake area
                const rect = cakeArea.getBoundingClientRect();
                let x = event.clientX - rect.left - (newElement.offsetWidth / 2);
                let y = event.clientY - rect.top - (newElement.offsetHeight / 2);

                // Ensure decorations are within cake area bounds
                // Get the current dimensions of the cake area
                const cakeAreaRect = cakeArea.getBoundingClientRect();

                x = Math.max(0, Math.min(x, cakeAreaRect.width - newElement.offsetWidth));
                y = Math.max(0, Math.min(y, cakeAreaRect.height - newElement.offsetHeight));

                newElement.style.left = `${x}px`;
                // Position relative to the bottom of the cake area, adjusted by current cake height
                newElement.style.bottom = `${cakeArea.offsetHeight - y - newElement.offsetHeight}px`;

                newElement.classList.add(component.id); // Add specific class for styling
                cakeArea.appendChild(newElement);
                playHappySoundVisual();
                showMiniConfetti();
                showModal("Sparkle & Shine!", `You've added a magical ${component.name}! Just like Peehu, your cake is shining bright!`);

                // If it's a candle, add a special birthday message
                if (component.id === 'candle') {
                    showModal("Make a Wish!", "Another candle, another year of amazing adventures! Happy Birthday, Peehu! May all your wishes come true!");
                }
            }

            totalComponentsAdded++;

            // Mid-game messages based on total components
            if (totalComponentsAdded === 3) {
                showModal("Building Brilliance!", "This cake is shaping up beautifully for Peehu! Every piece adds to the birthday magic!");
            } else if (totalComponentsAdded === 6) {
                showModal("Almost a Masterpiece!", "Peehu's cake is getting more amazing with every component! You're a true cake artist!");
            }

            // Remove the item from the palette if it's a layer or frosting (single use)
            if (component.type === 'layer' || component.type === 'frosting') {
                const paletteItem = document.querySelector(`.palette-item[data-component-id="${component.id}"]`);
                if (paletteItem) {
                    paletteItem.remove();
                }
            }
        }

        function finishCake() {
            const numLayers = cakeLayers.filter(el => el.classList.contains('layer')).length;
            const numFrostings = cakeLayers.filter(el => el.classList.contains('frosting')).length;
            const numDecorations = cakeLayers.filter(el => el.classList.contains('decoration')).length;

            if (numLayers < 1 || numFrostings < 1) { // Require at least one layer and one frosting
                showModal("Almost There!", "A birthday cake needs at least one cake layer and some delicious frosting! Keep building!");
                return;
            }

            showConfetti(300, 7000); // Grand confetti
            showBurstEmojis(30); // Grand emoji burst
            playHappySoundVisual();
            
            // Hide build buttons, show cut button
            document.getElementById('resetCakeBtn').style.display = 'none';
            document.getElementById('finishCakeBtn').style.display = 'none';
            document.getElementById('cutCakeBtn').style.display = 'inline-block';

            showModal(
                "üéÇ Your Masterpiece is Ready! üéÇ",
                `With ${numLayers} layers, ${numFrostings} frostings, and ${numDecorations} dazzling decorations, this cake is perfect for Peehu! Now, let's cut it!`,
                null // No immediate goHome, user clicks "Cut the Cake"
            );
        }

        // New function for cutting the cake
        function cutCake() {
            hideModal(); // Hide any open modal
            // Show the final birthday message
            showModal(
                "üéâ HAPPY 13TH BIRTHDAY, PEEHU! üéâ",
                "May your special day be filled with joy, laughter, and all your wishes come true! We love you!",
                () => { // Callback after modal closes
                    // After the confetti, go home
                    setTimeout(goHome, 1000); // Give a moment for confetti to settle
                }
            );

            // Trigger non-stop star confetti from corners for 3 seconds
            showCornerConfetti(3000); // 3 seconds duration
        }

        // New function for corner confetti
        function showCornerConfetti(duration = 3000) {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti';
            document.body.appendChild(confettiContainer);

            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7aa', '#96ceb4', '#ffeaa7', '#fd79a8', '#fdcb6e'];
            
            const startTime = Date.now();
            const interval = setInterval(() => {
                if (Date.now() - startTime > duration) {
                    clearInterval(interval);
                    confettiContainer.remove();
                    return;
                }

                for (let i = 0; i < 10; i++) { // Generate more pieces per interval for a shower effect
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 1.5) + 's'; // Faster, more continuous
                    
                    // Force star shape for corner confetti
                    confetti.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                    confetti.style.borderRadius = '0';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;


                    // Randomly choose left or right bottom corner
                    if (Math.random() < 0.5) {
                        confetti.style.left = (Math.random() * 10) + '%'; // Near left bottom
                        confetti.style.top = (90 + Math.random() * 10) + '%'; // Near bottom
                        confetti.style.animationName = 'corner-confetti-left';
                    } else {
                        confetti.style.left = (90 + Math.random() * 10) + '%'; // Near right bottom
                        confetti.style.top = (90 + Math.random() * 10) + '%'; // Near bottom
                        confetti.style.animationName = 'corner-confetti-right';
                    }
                    confettiContainer.appendChild(confetti);

                    // Remove confetti pieces after their animation
                    setTimeout(() => confetti.remove(), parseFloat(confetti.style.animationDuration) * 1000);
                }
            }, 50); // Spawn new confetti every 50ms for a denser shower
        }


        // --- Navigation ---
        function goHome() {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.style.display = 'none';
            });
            document.getElementById('welcomeScreen').style.display = 'block';
            
            // Any game-specific cleanup goes here if needed
            // For cake builder, ensure it's reset when leaving
            resetCakeBuilder(); 
            hideModal(); // Ensure modal is hidden when going home
        }

        // --- Initialize Page ---
        window.onload = function() {
            createStars();
            createParticles();
            createFloatingEmojis();
            // Ensure welcome screen is visible on load
            document.getElementById('welcomeScreen').style.display = 'block';

            // Initialize cakeArea and cakePalette here to ensure they are available
            cakeArea = document.getElementById('cakeArea');
            cakePalette = document.getElementById('cakePalette');
        };
    </script>
</body>
</html>
